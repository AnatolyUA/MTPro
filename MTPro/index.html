<!DOCTYPE html>
<html lang="en">
    <head>
        <title></title>
        <meta charset="utf-8" />
        <script src="cordova.js"></script>
        <script src="kendo/js/jquery.min.js"></script>
        <script src="kendo/js/kendo.mobile.min.js"></script>





        <script src="scripts/newsCategories.js"></script>
        <script src="scripts/ScrollViewInfinite.js"></script>

        <link href="kendo/styles/kendo.mobile.all.min.css" rel="stylesheet" />
        <link href="styles/main.css" rel="stylesheet" />
        <style>
            .pullImage {
                width: 80px;
                height: 80px;
                border-radius: 3px;
                float: left;
                margin-right: 10px;
            }
            .date {
                float: right;
                font-size: 0.8em;
                color: #808080;
            }

            #scrollview div div, .km-scrollview div div {
                white-space:normal;
            }

        </style>
    </head>
    <body>

    <div data-role="view" id="test">
        <div id="sv"></div>
    </div>

        <div data-role="view" data-show="viewModelStoriesList.initScrollViewContent" data-init="newsListInit" data-title="Maritime Professional News" id="tabstrip-newsList">
            <ul id="newsList"></ul>


            <div data-role="popover" id="popover-categories" data-open="openPopover">
                <div data-role="view" data-title="Categories">
                    <div data-role="header">
                        <div data-role="navbar">
                            <span data-role="view-title"></span>
                            <a data-role="button" data-align="right" data-click="closeParentPopover">Close</a>
                        </div>
                    </div>
                    <ul id="newsCategoriesList"></ul>
                </div>
            </div>




        </div>

        <div data-role="view" data-show="readStory" data-model="viewModelStory" id="StoryModel">
            <h1 data-bind="text: Title"></h1>
            <div data-bind="visible: HasImages">Image Available</div>
            <p data-bind="text: Author" class="author"></p>
            <p data-bind="text: DatePublished" class="date"></p>
            <div data-bind="html: ContentHtml"></div>
        </div>

        <div data-role="view" id="StoriesListSlider" data-show="scrollTop">
            <div id="scrollview-container">
                <div id="scrollview"></div>
            </div>
        </div>

        <div data-role="view" id="connectionError" data-title="Network error">
            <p>Can't connect to the remote server. </p>
            <a id="btnRetry" data-role="button" data-click="onRetryClick">Retry</a>
        </div>
        <div data-role="view" data-show="refreshStory" id="connectionErrorStory" data-title="Network error">
            <p>Can't connect to the remote server. Please refresh</p>
            <a id="refresh" data-role="button">Refresh</a>
        </div>

        <div data-role="layout" data-id="mobile-tabstrip">
            <header data-role="header">
                <div data-role="navbar">
                    <span data-role="view-title"></span>
                    <a data-align="left" data-rel="popover" href="#popover-categories" data-role="button">Categories</a>
                </div>
            </header>

            <div data-role="footer">
                <div data-role="tabstrip">
                    <a href="#tabstrip-newsList" data-icon="home">Home</a>
                    <a href="#StoriesListSlider" data-icon="globe">List</a>


                </div>
            </div>
        </div>

        <script>
            var app = new kendo.mobile.Application(document.body, {
                transition: "slide",
                layout: "mobile-tabstrip",
                initial: "tabstrip-newsList",
                platform: "ios"
            });
            newsCategories.init();
        </script>


        <div data-role="view" id="Story" data-show="readStory">
            <div id="StoryContent"></div>
        </div>


<!-- <a href="\\#StoryModel?storyId=#= StoryEid #" data-storyid="#= StoryEid #"> -->
        <script id="newsList-template" type="text/x-kendo-template">

            <a href="\\#test">
                <div class="Story"  data-storyid="#= StoryEid #">
                    #if (ImageSrc) { #
                        <img class="pullImage" src="#= ImageSrc #" alt="#= Title #" />
                    # } #
                    <h2>#= Title #</h2>
                    <p class="description">#= Description # <span class="date">#= kendo.toString(new Date(parseInt(DatePublished.substr(6))), "dd MMM HH:mm") #</span></p>

                </div>
            </a>

        </script>

        <script type="text/x-kendo-template" id="story-template">
            <h1>#= Title #</h1>
            <p class="date">#= kendo.toString(new Date(parseInt(DatePublished.substr(6))), "dd MMM HH:mm") #</p>
            <p class="author">#= Author #</p>

            #= ContentHTML #
        </script>

        <script type="text/x-kendo-template" id="story-details-template">
            <h1>#= Title #</h1>
            <p class="date">#= DatePublished #</p>
            <p class="author">#= Author #</p>

            #= ContentHtml #
        </script>

        <script type="text/x-kendo-template" id="row-template">
            <div data-role="page">
                <h1>#= Title #</h1>
                <p class="date">#= DatePublished #</p>
                <p class="author">#= Author #</p>

                
                #= ContentHtml #
            </div>
        </script>

    <script type="text/x-kendo-template" id="row-category">
        <li><label>#= CategoryDisplay #<input type="checkbox"></label></li>
    </script>

    <script type="text/x-kendo-template" id="full-news-item">
        <h1>#= Title #</h1>
        <p class="date">#= kendo.toString(new Date(parseInt(DatePublished.substr(6))), "dd MMM HH:mm") #</p>
        <p class="author">#= Author #</p>

        #= ContentHTML #
    </script>


        <script>
            var viewModelStory = new kendo.observable({
                StoryEID: "",
                Title:"",
                Author:"",
                DatePublished:"",
                ContentHtml:"",
                ImageHtml: "",
                HasImages: function() {
                    if (this.ImageHtml != "")
                        return true;
                    return false;
                },
                setFieldsFromListClick: function(e) {
                    var that = this;
                    var storyId = e.item.find("a").data("storyid");
                    if (storyId) {
                        that.set("StoryEID", storyId);
                        that.set("Title", e.item.find("h2").html());
                        // that.set("Author", e.item.find("p.description").html());
                        that.set("DatePublished", e.item.find("span.date").html());
                        that.set("ContentHtml", "<p>" + e.item.find("p.description").html() + "</p>");
                    }
                }
            });

            var viewModelStoriesList = new kendo.observable({
                Stories: [],
                StoriesIndex: [],
                PagesQueue: [],
                Template: kendo.template($("#story-details-template").html()),
                getScrollView: function() {
                    var that = this;
                    if ($("#scrollview").data("kendoMobileScrollView")) {
                        return $("#scrollview").data("kendoMobileScrollView");
                    }

                    $("#scrollview").kendoMobileScrollView({
                        change: function(e) {
                            that.populateScrollVewContent(e.page);
                        },
                        page: 2
                    });

                    return $("#scrollview").data("kendoMobileScrollView");
                },
                populateScrollVewContent: function(page) {
                    var that = this;
                    that.addContentToScrollViewPage(page);
                    that.addContentToScrollViewPage(page + 1);
                    that.addContentToScrollViewPage(page - 1);
                    that.clearContentOfScrollVewPage(page - 2);
                    that.clearContentOfScrollVewPage(page + 2);
                    if (scrollerInstance)
                        scrollerInstance.reset();

                },
                populateScrollVewContentByEvent: function(e) {
                    var page = viewModelStoriesList.getScrollView().page;

                    viewModelStoriesList.populateScrollVewContent(page);
                },
                clearContentOfScrollVewPage: function(page) {
                    var divIndex = page + 1;
                    if (page >= 0 && page <= this.StoriesIndex.length)
                        $("#scrollview div div:nth-child(" + divIndex + ")").html("");
                },
                navigateToStoryId: function(storyId) {
                    window.app.navigate("#StoriesListSlider");
                    var that = this;
                    var page = that.getStoryIdPage(storyId);
                    if (page != -1) {
                        that.getScrollView().scrollTo(page);
                        that.populateScrollVewContent(page);
                    }

                },
                getStoryPage: function(story) {
                    return this.getStoryIdPage(story.StoryEID);
                },
                getStoryIdPage: function(storyId){
                    return this.get("StoriesIndex").indexOf(storyId);
                },
                addStory: function(story, flag) {
                    var that = this;
                    if (that.get("StoriesIndex").indexOf(story.StoryEID) === -1) {
                        that.get("Stories").push(story);
                        that.get("StoriesIndex").push(story.StoryEID);
                        if (flag) that.initScrollViewContent();
                    }
                },
                addStories: function(stories) {
                    var that = this;
                    for (var i = 0; i < stories.length; i++) {
                        var dataItem = stories[i];
                        var story = {
                            IsFull: false,
                            StoryEID: dataItem.StoryEid,
                            Title: dataItem.Title,
                            Author: "",
                            DatePublished: kendo.toString(new Date(parseInt(dataItem.DatePublished.substr(6))), "dd MMM HH:mm"),
                            ContentHtml: "<p>" + dataItem.Description + "</p>"
                        };
                        that.addStory(story, false);
                    }
                    that.initScrollViewContent();
                },
                updateStory: function(story) {
                    var that = this;
                    var i = that.get("StoriesIndex").indexOf(story.StoryEID);
                    if (i === -1) {
                        that.addStory(story, true);
                    } else {
                        that.get("Stories").splice(i, 1, story);
                    }
                },
                updateStoryFromServerByPage: function(page) {
                    var that = this;
                    if (that.get("StoriesIndex")[page]) {
                        that.updateStoryFromServer(that.get("StoriesIndex")[page]);
                    }
                },
                updateStoryFromServer: function(storyId) {
                    var that = this;
                    $.ajax({
                        url: "http://api.maritimeprofessional.com/json/Story?id=" + storyId,
                        dataType:"jsonp",
                        success: function(data) {
                            var story = {
                                IsFull: true,
                                StoryEID: data.StoryEID,
                                Title: data.Title,
                                Author: data.Author,
                                DatePublished: kendo.toString(new Date(parseInt(data.DatePublished.substr(6))), "dd MMM HH:mm"),
                                ContentHtml: data.ContentHTML
                            };
                            that.updateStory(story);
                            that.addContentToScrollViewStory(story);
                        },
                        error: function(xmlhttprequest, textstatus, message) {
                            if (message === "timeout") {
                                window.app.navigate("#tabstrip-newsList");
                            }
                        }
                    });
                },
                addContentToScrollViewPage: function(page) {
                    var that = this;
                    if (that.Stories[page]) {
                        var divIndex = page + 1;
                        $("#scrollview div div:nth-child(" + divIndex + ")").html(that.Template(that.Stories[page]));
                        if (!that.Stories[page].IsFull) {
                            that.updateStoryFromServerByPage(page);
                        }
                    }
                },
                addContentToScrollViewStory: function(story) {
                    var that = this;
                    var page = that.getStoryPage(story);
                    that.addContentToScrollViewPage(page);
                },
                initScrollViewContent: function() {
                    if (viewModelStoriesList.StoriesIndex) {
                        var count = viewModelStoriesList.StoriesIndex.length;
                        var content = "";
                        for (var i = 0; i < count; i++) {
                            content = content + '<div data-role="page"></div>';
                        }
                        viewModelStoriesList.getScrollView().content(content);
                        // viewModelStoriesList.populateScrollVewContent(that.getScrollView().page);
                    }
                },
                reset: function(){
                    var that = this;
                    that.set("StoriesIndex", new kendo.data.ObservableArray());
                    that.set("Stories", new kendo.data.ObservableArray());
                }
            });
            // kendo.bind($("#StoriesListSlider"), viewModelStoriesList);




            $("#sv").kendoScrollViewInfinite({
                fullItemTemplate: $("#full-news-item").html()
            });
            var scrollViewInfinite = $("#sv").data("kendoScrollViewInfinite");

            var dataSource;
            var listview;
            function newsListInit() {

                dataSource = new kendo.data.DataSource({
                    pageSize: 12,
                    serverPaging: true,
                    transport: {
                        read: {
                            url: "http://api.maritimeprofessional.com/json/StreamNews", // the remove service url
                            dataType: "jsonp", // JSONP (JSON with padding) is required for cross-domain AJAX
                            timeout: 10000
                        },
                        parameterMap: function(options) {
                            var parameters = {
                                imageWidth:80,
                                ImageHeight:80,
                                take: options.pageSize,
                                skip: options.skip,
                                minid: options.minid,
                                maxid: options.maxid
                                // page: options.page //next page
                            }

                            return parameters;
                        }
                    },
                    schema: { // describe the result format
                        data: "Stories" // the data which the data source will be bound to is in the "results" field
                    },
                    error: function(e) {
                        window.app.navigate("#connectionError");
                    },
                    requestStart: function() {
                        window.app.showLoading();
                    },
                    requestEnd: function (e) {
                        window.app.hideLoading();
                        var data = e.response.Stories;
                        // viewModelStoriesList.addStories(data);
                        // var listView = $("#newsList").data("kendoMobileListView");

                    }
                });

                $("#newsList").kendoMobileListView({
                    dataSource: dataSource,
                    template: $("#newsList-template").text(),
                    click: function (e) {
                        // viewModelStory.setFieldsFromListClick(e);
                        // viewModelStoriesList.navigateToStoryId(e.item.find("div.Story").data("storyid"));
                        scrollViewInfinite.navigateTo(e.item.find("div.Story").data("storyid"));
                    },
                    scrollTreshold: 30, //treshold in pixels
                    appendOnRefresh: true,
                    pullToRefresh: true,
                    //addition parameters which will be passed to the DataSource's read method
                    pullParameters: function(item) { //pass first data item of the ListView
                        return {
                            maxid: $("#newsList li:first-child").find("div.Story").data("storyid") // item.StoryEid,
                            // page: 1
                        };
                    },
                    endlessScroll: true,
                    //addition parameters which will be passed to the DataSource's next method
                    endlessScrollParameters: function(first, last) {
//                        while ($("#newsList").children().length > 12) {
//                            $("#newsList li:first-child").remove();
//                        }
//                        $("#newsList").data("kendoMobileListView").refresh();
                        return {
                            minid: $("#newsList li:last-child").find("div.Story").data("storyid")
                        }
                    }
                });

                listview = $("#newsList").data("kendoMobileListView");

            }

            function onRetryClick(e){
                newsListInit();
                window.app.navigate("#tabstrip-newsList");
            }


            var currentStoryId = "";
            var storyTemplate = kendo.template($("#story-template").html());
            var timeoutVal = 10000;
            function readStory(e) {
                e.view.scroller.reset();

                var storyId = e.view.params.storyId;
                currentStoryId = storyId;
                $("#StoryContent").html("Please, wait...");
                window.app.showLoading();

                $.ajax({
                    url: "http://api.maritimeprofessional.com/json/Story?id=" + storyId,
                    dataType:"jsonp",
                    timeout:timeoutVal,
                    success: function(data) {
                        window.app.hideLoading();
                        $("#StoryContent").html(storyTemplate(data));



                        viewModelStory.set("StoryEID", data.StoryEID);
                        viewModelStory.set("Title", data.Title);
                        viewModelStory.set("Author", data.Author);
                        viewModelStory.set("DatePublished", kendo.toString(new Date(parseInt(data.DatePublished.substr(6))), "dd MMM HH:mm"));
                        viewModelStory.set("ContentHtml", data.ContentHTML);
                    },
                    error: function(xmlhttprequest, textstatus, message) {
                        if (message === "timeout") {
                            timeoutVal = timeoutVal + 500;
                            window.app.navigate("#connectionErrorStory");
                        }
                    }
                });

            }

            function refreshStory() {
                window.app.hideLoading();
                $("#refresh").kendoMobileButton({
                    icon: "refresh",
                    click: function(e) {
                        window.app.navigate("#Story?storyId=" + currentStoryId);
                    }
                });
            }

            var scrollerInstance = null; ///////
            function scrollTop(e) {
                scrollerInstance = e.view.scroller;
                scrollerInstance.reset();
            }

            function closeParentPopover(e) {
                var popover = e.sender.element.closest('[data-role=popover]').data('kendoMobilePopOver');
                popover.close();
            }

            var v;
            function openPopover(e) {
                var popover = e.sender.element.parent();
                v = app.pane.viewEngine.view().element.find("[data-role=content]");
                popover.height(v.height() - 20);
                popover.width(v.width() - 30);
            }

//            var s;
//            function sv(num, start) {
//                if (s) {
//                    s.destroy();
//                    $("#sv").html("");
//                }
//                for (var i = 1; i <= num; i++) {
//                    $("#sv").append("<div data-role='page'><h1>" + i + "</h1></div>");
//                }
//                $("#sv").kendoMobileScrollView({ page: start });
//                s = $("#sv").data("kendoMobileScrollView");
//                s.refresh();
//            }

            var NewsCategory = kendo.data.Model.define({
                id: "CategoryEID",
                fields: {
                    CategoryEID: {},
                    CategoryDisplay: {},
                    IsSelected: {
                        type: "boolean",
                        defaultValue: false
                    }
                }
            });



        var dataSourceForC = new kendo.data.DataSource({
            transport: {
                read: {
                    url: "http://api.maritimeprofessional.com/json/CategoriesList", // the remove service url
                    dataType: "jsonp", // JSONP (JSON with padding) is required for cross-domain AJAX
                    timeout: 10000
                }
            },
            schema: {
                model: NewsCategory // Use the existing Product model
            }
        });

            var NewsCategories = new kendo.observable({
                categories: dataSourceForC,

                getActive:function() {},
                categoryClick:function(e) {
                    var c = e.data;
                    console.log(e.data.toString());
                }
            });

        </script>

    </body>
</html>
