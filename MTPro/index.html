<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta charset="utf-8" />
        <script src="cordova.js"></script>
        <script src="kendo/js/jquery.min.js"></script>
        <script src="kendo/js/kendo.mobile.min.js"></script>
        <script src="http://maps.google.com/maps/api/js?sensor=true"></script>
        <script src="scripts/hello-world.js"></script>

        <link href="kendo/styles/kendo.mobile.all.min.css" rel="stylesheet" />
        <link href="styles/main.css" rel="stylesheet" />
    </head>
    <body>

        <div data-role="view" data-init="newsListInit" data-title="Latest news" id="tabstrip-newsList">
            <ul id="newsList"></ul>
        </div>

        <div data-role="view" data-show="readStory" data-model="viewModelStory" id="StoryModel">
            <h1 data-bind="text: Title"></h1>
            <div data-bind="visible: HasImages">Image Available</div>
            <p data-bind="text: Author" class="author"></p>
            <p data-bind="text: DatePublished" class="date"></p>
            <div data-bind="html: ContentHtml"></div>
        </div>

        <div data-role="view" id="connectionError" data-title="Network error">
            <p>Can't connect to the remote server. </p>
            <a id="btnRetry" data-role="button" data-click="onRetryClick">Retry</a>
        </div>
        <div data-role="view" data-show="refreshStory" id="connectionErrorStory" data-title="Network error">
            <p>Can't connect to the remote server. Please refresh</p>
            <a id="refresh" data-role="button">Refresh</a>
        </div>

        <div data-role="layout" data-id="mobile-tabstrip">
            <header data-role="header">
                <div data-role="navbar">
                    <span data-role="view-title"></span>
                </div>
            </header>

            <div data-role="footer">
                <div data-role="tabstrip">
                    <a href="#tabstrip-newsList" data-icon="home">Home</a>
                </div>
            </div>
        </div>

        <script>
            var app = new kendo.mobile.Application(document.body, {
                transition: "slide",
                layout: "mobile-tabstrip",
                initial: "tabstrip-newsList",
                platform: "ios"
            });
        </script>


        <div data-role="view" id="Story" data-show="readStory">
            <div id="StoryContent"></div>
        </div>



        <script id="newsList-template" type="text/x-kendo-template">
            <a href="\\#StoryModel?storyId=#= StoryEid #" data-storyid="#= StoryEid #">
                <div class="Story">
                    #if (ImageSrc) { #
                        <img class="pullImage" src="#= ImageSrc #" alt="#= Title #" />
                    # } #
                    <h2>#= Title #</h2>
                    <p class="description">#= Description #</p>
                    <div class="metadata">
                        <span class="date">#= kendo.toString(new Date(parseInt(DatePublished.substr(6))), "dd MMM HH:mm") #</span>
                    </div>
                </div>
            </a>
        </script>

        <script type="text/x-kendo-template" id="storyTemplate">
            <h1>#= Title #</h1>
            <p class="date">#= kendo.toString(new Date(parseInt(DatePublished.substr(6))), "dd MMM HH:mm") #</p>
            <p class="author">#= Author #</p>

            #= ContentHTML #
        </script>


        <script>
            var viewModelStory = new kendo.observable({
                StoryEID: "",
                Title:"",
                Author:"",
                DatePublished:"",
                ContentHtml:"",
                ImageHtml: "",
                HasImages: function() {
                    if (this.ImageHtml != "")
                        return true;
                    return false;
                },
                setFieldsFromListClick: function(e) {
                    var that = this;
                    var storyId = e.item.find("a").data("storyid");
                    if (storyId) {
                        that.set("StoryEID", storyId);
                        that.set("Title", e.item.find("h2").html());
                        // that.set("Author", e.item.find("p.description").html());
                        that.set("DatePublished", e.item.find("span.date").html());
                        that.set("ContentHtml", "<p>" + e.item.find("p.description").html() + "</p>");
                    }
                }
            });


            function newsListInit() {
                var dataSource = new kendo.data.DataSource({
                    pageSize: 12,
                    serverPaging: true,
                    transport: {
                        read: {
                            url: "http://api.maritimeprofessional.com/json/StreamNews", // the remove service url
                            dataType: "jsonp", // JSONP (JSON with padding) is required for cross-domain AJAX
                            timeout: 10000
                        },
                        parameterMap: function(options) {
                            var parameters = {
                                imageWidth:80,
                                ImageHeight:60,
                                take: options.pageSize,
                                skip: options.skip
                                // page: options.page //next page
                            }

                            return parameters;
                        }
                    },
                    schema: { // describe the result format
                        data: "Stories" // the data which the data source will be bound to is in the "results" field
                    },
                    error: function(e) {
                        window.app.navigate("#connectionError");
                    },
                    requestStart: function() {
                        window.app.showLoading();
                    },
                    requestEnd: function (e) {
                        window.app.hideLoading();
                    }
                });

                $("#newsList").kendoMobileListView({
                    dataSource: dataSource,
                    template: $("#newsList-template").text(),
                    endlessScroll: true,
                    click: function (e) {
                        viewModelStory.setFieldsFromListClick(e);
                    },
                    scrollTreshold: 30 //treshold in pixels
                });
            }

            function onRetryClick(e){
                newsListInit();
                window.app.navigate("#tabstrip-newsList");
            }


            var currentStoryId = "";
            var storyTemplate = kendo.template($("#storyTemplate").html());
            var timeoutVal = 10000;
            function readStory(e) {
                e.view.scroller.reset();

                var storyId = e.view.params.storyId;
                currentStoryId = storyId;
                $("#StoryContent").html("Please, wait...");
                window.app.showLoading();

                $.ajax({
                    url: "http://api.maritimeprofessional.com/json/Story?id=" + storyId,
                    dataType:"jsonp",
                    timeout:timeoutVal,
                    success: function(data) {
                        window.app.hideLoading();
                        $("#StoryContent").html(storyTemplate(data));



                        viewModelStory.set("StoryEID", data.StoryEID);
                        viewModelStory.set("Title", data.Title);
                        viewModelStory.set("Author", data.Author);
                        viewModelStory.set("DatePublished", kendo.toString(new Date(parseInt(data.DatePublished.substr(6))), "dd MMM HH:mm"));
                        viewModelStory.set("ContentHtml", data.ContentHTML);
                    },
                    error: function(xmlhttprequest, textstatus, message) {
                        if (message === "timeout") {
                            timeoutVal = timeoutVal + 500;
                            window.app.navigate("#connectionErrorStory");
                        }
                    }
                });

            }

            function refreshStory() {
                window.app.hideLoading();
                $("#refresh").kendoMobileButton({
                    icon: "refresh",
                    click: function(e) {
                        window.app.navigate("#Story?storyId=" + currentStoryId);
                    }
                });
            }

        </script>
    </body>
</html>
